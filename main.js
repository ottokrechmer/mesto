(()=>{"use strict";class e{constructor(e,t,s){var i=e.data,r=e.handleCardClick,n=e.handleDeleteClick,o=e.handleLikeClick;this._name=i.name,this._url=i.link,this._owner=i.owner,this._likes=i.likes,this.cardId=i._id,this._handleCardClick=r,this._handleDeleteClick=n,this._handleLikeClick=o,this._templateSelector=t,this._userId=s}_getTemplate(){return document.querySelector(this._templateSelector).content.querySelector(".element").cloneNode(!0)}_checkIsLikedByUser(){return this._likes.some((e=>e._id===this._userId))}generateCard(){return this._element=this._getTemplate(),this._likeButton=this._element.querySelector(".element__button"),this._checkIsLikedByUser()&&(this._isLiked=!0,this._likeButton.classList.add("element__button_liked")),this._deleteButton=this._element.querySelector(".element__delete-button"),this._image=this._element.querySelector(".element__image"),this._image.src=this._url,this._image.alt=this._name,this._element.querySelector(".element__name").textContent=this._name,this._likeCount=this._element.querySelector(".element__like-count"),this._likeCount.textContent=this._likes.length,this._setEventListeners(),this._owner._id!=this._userId&&this._deleteButton.remove(),this._element}deleteCard(){this._element.remove(),this._element=null}_setEventListeners(){this._likeButton.addEventListener("click",(e=>{this._handleLikeClick(this)})),this._deleteButton.addEventListener("click",(e=>{this._handleDeleteClick(this)})),this._image.addEventListener("click",(e=>{this._handleCardClick(this._name,this._url)}))}}var t=".profile__avatar",s={inactiveButtonClass:"popup__submit-button_disabled",popupTextInputSelector:".popup__text-input",submitButtonSelector:".popup__submit-button",inputErrorClass:"popup__input_type_error",errorClassVisible:"popup__error_visible"};class i{constructor(e){this._popup=document.querySelector(e),this._closeButton=this._popup.querySelector(".popup__close-button"),this._handleEscClose=this._handleEscClose.bind(this),this._popupOpenedSelector="popup_opened",this._submitButton=this._popup.querySelector(".popup__submit-button")}open(){this._popup.classList.add(this._popupOpenedSelector),document.addEventListener("keydown",this._handleEscClose)}close(){this._popup.classList.remove(this._popupOpenedSelector),document.removeEventListener("keydown",this._handleEscClose)}setEventListeners(){this._popup.addEventListener("click",(e=>this._handleOverlayClickClose(e))),this._closeButton.addEventListener("click",this.close.bind(this))}_handleOverlayClickClose(e){e.target.classList.contains("popup")&&this.close()}_handleEscClose(e){"Escape"===e.key&&this.close()}}class r extends i{constructor(e,t){super(t),this._submitHandler=e,this._inputList=this._popup.querySelectorAll(".popup__text-input"),this._popupForm=this._popup.querySelector(".popup__form")}_getInputValues(){var e={};return this._inputList.forEach((t=>{e[t.id]=t.value})),e}setInitialValues(e){this._inputList.forEach((t=>{t.value=e[t.id]}))}setEventListeners(){super.setEventListeners(),this._popup.addEventListener("submit",(e=>{this._submitHandler(this._getInputValues())}))}close(){super.close(),this._popupForm.reset()}open(){super.open()}}class n{constructor(e,t){this._form=document.querySelector(t).querySelector(".popup__form"),this._inputList=Array.from(this._form.querySelectorAll(e.popupTextInputSelector)),this._button=this._form.querySelector(e.submitButtonSelector),this._inactiveButtonClass=e.inactiveButtonClass,this._inputErrorClass=e.inputErrorClass,this._errorClassVisible=e.errorClassVisible}enableValidation(){this._form.addEventListener("submit",(function(e){e.preventDefault()})),this._setEventListeners()}_setEventListeners(){this.toggleButtonState(),this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._checkInputValidity(e),this.toggleButtonState()}))}))}_checkInputValidity(e){e.validity.valid?this._hideInputError(e):this._showInputError(e,e.validationMessage)}_showInputError(e,t){var s=this._form.querySelector(".".concat(e.id,"-error"));e.classList.add("".concat(this._inputErrorClass)),s.textContent=t,s.classList.add("".concat(this._errorClassVisible))}_hideInputError(e){var t=this._form.querySelector(".".concat(e.id,"-error"));e.classList.remove("".concat(this._inputErrorClass)),t.classList.remove("".concat(this._errorClassVisible)),t.textContent=""}_hasInvalidInput(){return this._inputList.some((e=>!e.validity.valid))}toggleInputState(){this._inputList.forEach((e=>{this._hideInputError(e)}))}toggleButtonState(){this._hasInvalidInput()?(this._button.classList.add("".concat(this._inactiveButtonClass)),this._button.setAttribute("disabled","disabled")):(this._button.classList.remove("".concat(this._inactiveButtonClass)),this._button.removeAttribute("disabled"))}}var o=new class{constructor(e){this._baseUrl=e.baseUrl,this._headers=e.headers}_parseResponse(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}getUserInfo(){return fetch(this._baseUrl.concat("/users/me"),{headers:this._headers}).then(this._parseResponse)}getCardList(){return fetch(this._baseUrl.concat("/cards"),{headers:this._headers}).then(this._parseResponse)}editUserProfile(e,t){return fetch(this._baseUrl.concat("/users/me"),{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e,about:t})}).then(this._parseResponse)}addNewCard(e,t){return fetch(this._baseUrl.concat("/cards"),{method:"POST",headers:this._headers,body:JSON.stringify({name:e,link:t})}).then(this._parseResponse)}deleteCard(e){return fetch(this._baseUrl.concat("/cards/".concat(e)),{method:"DELETE",headers:this._headers}).then(this._parseResponse)}addLikeToCard(e){return fetch(this._baseUrl.concat("/cards/".concat(e,"/likes")),{method:"PUT",headers:this._headers}).then(this._parseResponse)}removeLikeFromCard(e){return fetch(this._baseUrl.concat("/cards/".concat(e,"/likes")),{method:"DELETE",headers:this._headers}).then(this._parseResponse)}editUserAvatar(e){return fetch(this._baseUrl.concat("/users/me/avatar"),{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e})}).then(this._parseResponse)}}({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-39",headers:{authorization:"8ba23565-e2b5-43ed-a77b-a5d2ecde101d","Content-Type":"application/json"}}),a=new class extends i{constructor(e){super(e),this._imageDescription=this._popup.querySelector(".popup__description-text"),this._bigImage=this._popup.querySelector(".popup__image")}open(e,t){this._bigImage.alt=e,this._bigImage.src=t,this._imageDescription.textContent=this._imageName,super.open()}}(".popup-image"),l=document.querySelector(".profile__button_type_edit"),c=document.querySelector(".profile__button_type_add"),h=document.querySelector(t),u=new class{constructor(e,t,s){this._profileName=document.querySelector(e),this._profileDescription=document.querySelector(t),this._avatar=document.querySelector(s)}getUserInfo(){return{userName:this._profileName.textContent,userDescription:this._profileDescription.textContent}}getUserAvatar(){return{avatarUrl:this._avatar.src}}setUserInfo(e,t){this._profileName.textContent=e,this._profileDescription.textContent=t}setUserId(e){this._id=e}getUserId(){return this._id}setUserAvatar(e){this._avatar.src=e}}(".profile__name",".profile__description",t),_=new class{constructor(e,t){var s=e.renderer;this._renderer=s,this._container=document.querySelector(t)}_clear(){this._container.innerHTML=""}setItems(e){this._items=e}render(){this._items.forEach((e=>{this._renderer(e)}))}addItem(e){this._container.prepend(e)}}({renderer:k},".elements"),d=new r((function(e){d._submitButton.textContent="Сохранение...",o.editUserAvatar(e.avatarUrl).then((e=>{u.setUserAvatar(e.avatar),d.close()})).catch((e=>{console.log(e)})).finally((()=>{d._submitButton.textContent="Сохранить"}))}),".popup-avatar"),p=new n(s,".popup-avatar"),m=new r((function(e){m._submitButton.textContent="Сохранение...",o.editUserProfile(e.userName,e.userDescription).then((e=>{u.setUserInfo(e.name,e.about),m.close()})).catch((e=>{console.log(e)})).finally((()=>{m._submitButton.textContent="Сохранить"}))}),".popup-profile"),v=new n(s,".popup-profile"),C=new r((function(e){C._submitButton.textContent="Сохранение...",o.addNewCard(e.imageName,e.imageUrl).then((e=>{k(e),C.close(),b.enableValidation()})).catch((e=>{console.log(e)})).finally((()=>{C._submitButton.textContent="Сохранить"}))}),".popup-card"),b=new n(s,".popup-card"),g=new class extends i{constructor(e,t){super(t),this._submitHandler=e}setEventListeners(){super.setEventListeners(),this._popup.addEventListener("submit",(e=>{e.preventDefault(),this._submitHandler(this._card)}))}close(){super.close()}open(e){super.open(),this._card=e}}((function(e){g._submitButton.textContent="Удаление...",o.deleteCard(e.cardId).then((()=>{e.deleteCard(),g.close()})).catch((e=>{console.log(e)})).finally((()=>{g._submitButton.textContent="Ок"}))}),".popup-delete");function k(t){var s=function(t){return new e({data:t,handleCardClick:(e,t)=>{a.open(e,t)},handleDeleteClick:e=>{g.open(e)},handleLikeClick:e=>{e._isLiked?o.removeLikeFromCard(e.cardId).then((t=>{e._likeButton.classList.toggle("element__button_liked"),e._likeCount.textContent=t.likes.length,e._isLiked=!1})).catch((e=>{console.log(e)})):o.addLikeToCard(e.cardId).then((t=>{e._likeButton.classList.toggle("element__button_liked"),e._likeCount.textContent=t.likes.length,e._isLiked=!0})).catch((e=>{console.log(e)}))}},"#matrix-element-template",u.getUserId()).generateCard()}(t);_.addItem(s)}Promise.all([o.getUserInfo(),o.getCardList()]).then((e=>{u.setUserInfo(e[0].name,e[0].about),u.setUserAvatar(e[0].avatar),u.setUserId(e[0]._id),_.setItems(e[1]),_.render()})).catch((e=>{console.log(e)})),c.addEventListener("click",(e=>{C.open(),b.toggleInputState()})),l.addEventListener("click",(e=>{m.setInitialValues(u.getUserInfo()),m.open(),v.toggleInputState()})),h.addEventListener("click",(e=>{d.setInitialValues(u.getUserAvatar()),d.open(),p.toggleInputState()})),C.setEventListeners(),m.setEventListeners(),a.setEventListeners(),d.setEventListeners(),g.setEventListeners(),v.enableValidation(),b.enableValidation(),p.enableValidation()})();