(()=>{"use strict";class e{constructor(e,t,s){var i=e.data,r=e.handleCardClick,n=e.handleDeleteClick,o=e.handleLikeClick;this._name=i.name,this._url=i.link,this._owner=i.owner,this._likes=i.likes,this.cardId=i._id,this._handleCardClick=r,this._handleDeleteClick=n,this._handleLikeClick=o,this._templateSelector=t,this._userId=s}_getTemplate(){return document.querySelector(this._templateSelector).content.querySelector(".element").cloneNode(!0)}_checkIsLikedByUser(){return this._likes.some((e=>e._id===this._userId))}generateCard(){return this._element=this._getTemplate(),this._likeButton=this._element.querySelector(".element__button"),this._checkIsLikedByUser()&&(this._isLiked=!0,this._likeButton.classList.add("element__button_liked")),this._deleteButton=this._element.querySelector(".element__delete-button"),this._image=this._element.querySelector(".element__image"),this._image.src=this._url,this._image.alt=this._name,this._element.querySelector(".element__name").textContent=this._name,this._likeCount=this._element.querySelector(".element__like-count"),this._likeCount.textContent=this._likes.length,this._setEventListeners(),this._owner._id!=this._userId&&this._deleteButton.remove(),this._element}_setEventListeners(){this._likeButton.addEventListener("click",(e=>{this._handleLikeClick(this)})),this._deleteButton.addEventListener("click",(e=>{this._handleDeleteClick(this)})),this._image.addEventListener("click",(e=>{this._handleCardClick(this._name,this._url)}))}}var t=".profile__avatar",s=".popup__text-input",i=".popup__submit-button",r="popup__submit-button_disabled",n="popup__input_type_error",o="popup__error_visible";class a{constructor(e){this._popup=document.querySelector(e),this._closeButton=this._popup.querySelector(".popup__close-button"),this._handleEscClose=this._handleEscClose.bind(this),this._popupOpenedSelector="popup_opened",this._submitButton=this._popup.querySelector(".popup__submit-button")}open(){this._popup.classList.add(this._popupOpenedSelector),document.addEventListener("keydown",this._handleEscClose)}close(){this._popup.classList.remove(this._popupOpenedSelector),document.removeEventListener("keydown",this._handleEscClose)}setEventListeners(){this._popup.addEventListener("click",(e=>this._handleOverlayClickClose(e))),this._closeButton.addEventListener("click",this.close.bind(this))}_handleOverlayClickClose(e){e.target.classList.contains("popup")&&this.close()}_handleEscClose(e){"Escape"===e.key&&this.close()}}class l extends a{constructor(e,t){super(t),this._submitHandler=e,this._inputList=this._popup.querySelectorAll(".popup__text-input"),this._popupForm=this._popup.querySelector(".popup__form")}_getInputValues(){var e={};return this._inputList.forEach((t=>{e[t.id]=t.value})),e}setInitialValues(e){this._inputList.forEach((t=>{t.value=e[t.id]}))}setEventListeners(){super.setEventListeners(),this._popup.addEventListener("submit",(e=>{this._submitHandler(this._getInputValues())}))}close(){super.close(),this._popupForm.reset()}open(){super.open()}}class c{constructor(e,t){this._form=document.querySelector(t).querySelector(".popup__form"),this._inputList=Array.from(this._form.querySelectorAll(e.popupTextInputSelector)),this._button=this._form.querySelector(e.submitButtonSelector),this._inactiveButtonClass=e.inactiveButtonClass,this._inputErrorClass=e.inputErrorClass,this._errorClassVisible=e.errorClassVisible}enableValidation(){this._form.addEventListener("submit",(function(e){e.preventDefault()})),this._setEventListeners()}_setEventListeners(){this.toggleButtonState(),this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._checkInputValidity(e),this.toggleButtonState()}))}))}_checkInputValidity(e){e.validity.valid?this._hideInputError(e):this._showInputError(e,e.validationMessage)}_showInputError(e,t){var s=this._form.querySelector(".".concat(e.id,"-error"));e.classList.add("".concat(this._inputErrorClass)),s.textContent=t,s.classList.add("".concat(this._errorClassVisible))}_hideInputError(e){var t=this._form.querySelector(".".concat(e.id,"-error"));e.classList.remove("".concat(this._inputErrorClass)),t.classList.remove("".concat(this._errorClassVisible)),t.textContent=""}_hasInvalidInput(){return this._inputList.some((e=>!e.validity.valid))}toggleInputState(){this._inputList.forEach((e=>{this._hideInputError(e)}))}toggleButtonState(){this._hasInvalidInput()?(this._button.classList.add("".concat(this._inactiveButtonClass)),this._button.setAttribute("disabled","disabled")):(this._button.classList.remove("".concat(this._inactiveButtonClass)),this._button.removeAttribute("disabled"))}}var u=new class{constructor(e){this._baseUrl=e.baseUrl,this._headers=e.headers}_parseResponse(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}getUserInfo(){return fetch(this._baseUrl.concat("/users/me"),{headers:this._headers}).then(this._parseResponse)}getCardList(){return fetch(this._baseUrl.concat("/cards"),{headers:this._headers}).then(this._parseResponse)}editUserProfile(e,t){return fetch(this._baseUrl.concat("/users/me"),{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e,about:t})}).then(this._parseResponse)}addNewCard(e,t){return fetch(this._baseUrl.concat("/cards"),{method:"POST",headers:this._headers,body:JSON.stringify({name:e,link:t})}).then(this._parseResponse)}deleteCard(e){return fetch(this._baseUrl.concat("/cards/".concat(e)),{method:"DELETE",headers:this._headers}).then(this._parseResponse)}addLikeToCard(e){return fetch(this._baseUrl.concat("/cards/".concat(e,"/likes")),{method:"PUT",headers:this._headers}).then(this._parseResponse)}removeLikeFromCard(e){return fetch(this._baseUrl.concat("/cards/".concat(e,"/likes")),{method:"DELETE",headers:this._headers}).then(this._parseResponse)}editUserAvatar(e){return fetch(this._baseUrl.concat("/users/me/avatar"),{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e})}).then(this._parseResponse)}}({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-39",headers:{authorization:"8ba23565-e2b5-43ed-a77b-a5d2ecde101d","Content-Type":"application/json"}}),h=new class extends a{constructor(e){super(e),this._imageDescription=this._popup.querySelector(".popup__description-text"),this._bigImage=this._popup.querySelector(".popup__image")}open(e,t){this._bigImage.alt=e,this._bigImage.src=t,this._imageDescription.textContent=this._imageName,super.open()}}(".popup-image"),_=document.querySelector(".profile__button_type_edit"),p=document.querySelector(".profile__button_type_add"),d=document.querySelector(t),m=new class{constructor(e,t,s){this._profileName=document.querySelector(e),this._profileDescription=document.querySelector(t),this._avatar=document.querySelector(s)}getUserInfo(){return{userName:this._profileName.textContent,userDescription:this._profileDescription.textContent}}getUserAvatar(){return{avatarUrl:this._avatar.src}}setUserInfo(e,t){this._profileName.textContent=e,this._profileDescription.textContent=t}setUserId(e){this._id=e}getUserId(){return this._id}setUserAvatar(e){this._avatar.src=e}}(".profile__name",".profile__description",t),v=new class{constructor(e,t){var s=e.renderer;this._renderer=s,this._container=document.querySelector(t)}_clear(){this._container.innerHTML=""}setItems(e){this._items=e}render(){this._items.forEach((e=>{this._renderer(e)}))}addItem(e){this._container.prepend(e)}}({renderer:y},".elements"),C=new l((function(e){C._submitButton.textContent="Сохранение...",u.editUserAvatar(e.avatarUrl).then((e=>{m.setUserAvatar(e.avatar)})).catch((e=>{console.log(e)})).finally((()=>{C._submitButton.textContent="Сохранить"})),C.close()}),".popup-avatar"),b=new c({inactiveButtonClass:r,popupTextInputSelector:s,submitButtonSelector:i,inputErrorClass:n,errorClassVisible:o},".popup-avatar"),g=new l((function(e){g._submitButton.textContent="Сохранение...",u.editUserProfile(e.userName,e.userDescription).then((e=>{m.setUserInfo(e.name,e.about)})).catch((e=>{console.log(e)})).finally((()=>{g._submitButton.textContent="Сохранить"})),g.close()}),".popup-profile"),k=new c({inactiveButtonClass:r,popupTextInputSelector:s,submitButtonSelector:i,inputErrorClass:n,errorClassVisible:o},".popup-profile"),L=new l((function(e){L._submitButton.textContent="Сохранение...",u.addNewCard(e.imageName,e.imageUrl).then((e=>{y(e)})).catch((e=>{console.log(e)})).finally((()=>{L._submitButton.textContent="Сохранить"})),L.close()}),".popup-card"),f=new c({inactiveButtonClass:r,popupTextInputSelector:s,submitButtonSelector:i,inputErrorClass:n,errorClassVisible:o},".popup-card"),E=new class extends a{constructor(e,t){super(t),this._submitHandler=e}setEventListeners(){super.setEventListeners(),this._popup.addEventListener("submit",(e=>{e.preventDefault(),this._submitHandler(this._card)}))}close(){super.close()}open(e,t){super.open(),this._card=e}}((function(e){E._submitButton.textContent="Удаление...",u.deleteCard(e.cardId).then((()=>{e._element.remove(),e._element=null,E.close()})).catch((e=>{console.log(e)})).finally((()=>{E._submitButton.textContent="Ок"}))}),".popup-delete");function y(t){var s=function(t){return new e({data:t,handleCardClick:(e,t)=>{h.open(e,t)},handleDeleteClick:e=>{E.open(e)},handleLikeClick:e=>{e._isLiked?u.removeLikeFromCard(e.cardId).then((t=>{e._likeButton.classList.toggle("element__button_liked"),e._likeCount.textContent=t.likes.length,e._isLiked=!1})).catch((e=>{console.log(e)})):u.addLikeToCard(e.cardId).then((t=>{e._likeButton.classList.toggle("element__button_liked"),e._likeCount.textContent=t.likes.length,e._isLiked=!0})).catch((e=>{console.log(e)}))}},"#matrix-element-template",m.getUserId()).generateCard()}(t);v.addItem(s)}u.getCardList().then((e=>{v.setItems(e),v.render()})).catch((e=>{console.log(e)})),p.addEventListener("click",(e=>{L.open(),f.toggleInputState()})),_.addEventListener("click",(e=>{g.setInitialValues(m.getUserInfo()),g.open(),k.toggleInputState()})),d.addEventListener("click",(e=>{C.setInitialValues(m.getUserAvatar()),C.open(),b.toggleInputState()})),L.setEventListeners(),g.setEventListeners(),h.setEventListeners(),C.setEventListeners(),E.setEventListeners(),k.enableValidation(),f.enableValidation(),b.enableValidation(),u.getUserInfo().then((e=>{m.setUserInfo(e.name,e.about),m.setUserAvatar(e.avatar),m.setUserId(e._id)})).catch((e=>{console.log(e)}))})();